<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Files 监控面板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-50">
    <!-- 顶部导航栏 -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <svg class="h-8 w-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span class="ml-2 text-xl font-bold text-gray-900">Telegram Files 监控</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">欢迎, <strong>{{ username }}</strong></span>
                    <button onclick="openChangePasswordModal()" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                        修改密码
                    </button>
                    <button onclick="logout()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        登出
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- 状态卡片 -->
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4 mb-6">
            <!-- CPU 使用率 -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-md bg-indigo-500 p-3">
                                <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">CPU 使用率</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900" id="cpuUsage">--%</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 内存使用 -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-md bg-green-500 p-3">
                                <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">内存使用</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900" id="memoryUsage">-- GB</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 磁盘使用 -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-md bg-yellow-500 p-3">
                                <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">磁盘使用</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900" id="diskUsage">-- GB</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 云端存储 -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-md bg-blue-500 p-3">
                                <svg class="h-6 w-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                                </svg>
                            </div>
                        </div>
                        <div class="ml-5 w-0 flex-1">
                            <dl>
                                <dt class="text-sm font-medium text-gray-500 truncate">云端存储</dt>
                                <dd class="flex items-baseline">
                                    <div class="text-2xl font-semibold text-gray-900" id="cloudStorage">-- GB</div>
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 流量统计 -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">网络流量统计</h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
                    <!-- 实时上传速率 -->
                    <div>
                        <dt class="text-sm font-medium text-gray-500">实时上传速率</dt>
                        <dd class="mt-1 text-3xl font-semibold text-indigo-600" id="uploadSpeed">0 Mbps</dd>
                    </div>
                    <!-- 实时下载速率 -->
                    <div>
                        <dt class="text-sm font-medium text-gray-500">实时下载速率</dt>
                        <dd class="mt-1 text-3xl font-semibold text-green-600" id="downloadSpeed">0 Mbps</dd>
                    </div>
                    <!-- 总上传流量 -->
                    <div>
                        <dt class="text-sm font-medium text-gray-500">总上传流量</dt>
                        <dd class="mt-1 text-3xl font-semibold text-gray-900" id="totalUploaded">0 GB</dd>
                    </div>
                    <!-- 总下载流量 -->
                    <div>
                        <dt class="text-sm font-medium text-gray-500">总下载流量</dt>
                        <dd class="mt-1 text-3xl font-semibold text-gray-900" id="totalDownloaded">0 GB</dd>
                    </div>
                </div>
            </div>
        </div>

        <!-- 云存储容量 -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">云存储容量</h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="space-y-4">
                    <!-- 容量进度条 -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">使用情况</span>
                            <span class="text-sm font-medium text-gray-700" id="quotaPercent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="quotaBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- 容量详情 -->
                    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="text-sm text-gray-500">总容量</div>
                            <div class="mt-1 text-2xl font-semibold text-gray-900" id="quotaTotal">-- GB</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <div class="text-sm text-blue-700">已使用</div>
                            <div class="mt-1 text-2xl font-semibold text-blue-900" id="quotaUsed">-- GB</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4">
                            <div class="text-sm text-green-700">可用空间</div>
                            <div class="mt-1 text-2xl font-semibold text-green-900" id="quotaFree">-- GB</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 云存储配置 -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">云存储配置</h3>
                    <button onclick="loadRcloneRemotes()" class="px-3 py-1 text-xs font-medium rounded-md bg-indigo-600 text-white hover:bg-indigo-700">
                        刷新
                    </button>
                </div>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <!-- 当前配置显示 -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="text-sm font-medium text-gray-700 mb-2">当前配置</div>
                    <div class="text-sm text-gray-600">
                        <span class="font-medium">远程存储：</span><span id="currentRemote" class="text-blue-600">加载中...</span>
                    </div>
                    <div class="text-sm text-gray-600 mt-1">
                        <span class="font-medium">目标路径：</span><span id="currentPath" class="text-blue-600">加载中...</span>
                    </div>
                </div>

                <!-- 配置表单 -->
                <div class="space-y-4">
                    <!-- 选择远程存储 -->
                    <div>
                        <label for="remoteSelect" class="block text-sm font-medium text-gray-700 mb-2">
                            选择云存储
                        </label>
                        <select id="remoteSelect"
                                onchange="onRemoteSelect()"
                                class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md border">
                            <option value="">-- 请选择云存储 --</option>
                        </select>
                        <p class="mt-1 text-xs text-gray-500">当前已配置的 rclone 远程存储列表</p>
                    </div>

                    <!-- 输入目标路径 -->
                    <div>
                        <label for="targetPath" class="block text-sm font-medium text-gray-700 mb-2">
                            目标路径
                        </label>
                        <input type="text"
                               id="targetPath"
                               placeholder="/Media/tg files/data"
                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <p class="mt-1 text-xs text-gray-500">目标云存储中的文件夹路径，以 / 开头</p>
                    </div>

                    <!-- 路径预览 -->
                    <div class="p-3 bg-blue-50 rounded-md" id="pathPreview" style="display: none;">
                        <div class="text-sm font-medium text-blue-900 mb-1">完整路径预览：</div>
                        <div class="text-sm text-blue-700 font-mono" id="fullPathPreview">-</div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex justify-end space-x-3">
                        <button onclick="testConnection()"
                                id="testBtn"
                                class="px-4 py-2 text-sm font-medium rounded-md border border-gray-300 text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            测试连接
                        </button>
                        <button onclick="saveCloudConfig()"
                                id="saveCloudConfigBtn"
                                class="px-4 py-2 text-sm font-medium rounded-md border border-transparent text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            保存配置
                        </button>
                    </div>

                    <!-- 提示信息 -->
                    <div id="cloudConfigMessage" class="hidden mt-4">
                        <div class="rounded-md p-4" id="cloudConfigMessageContent">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg id="cloudConfigMessageIcon" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm font-medium" id="cloudConfigMessageText">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 上传进度 -->
        <div id="uploadProgressSection" class="bg-white shadow rounded-lg mb-6 hidden">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">文件上传进度</h3>
                    <span id="uploadStatus" class="px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">正在上传</span>
                </div>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="space-y-4">
                    <!-- 当前文件 -->
                    <div>
                        <div class="text-sm font-medium text-gray-700">当前文件</div>
                        <div class="mt-1 text-lg text-gray-900" id="currentFile">文件名.ext</div>
                    </div>
                    <!-- 进度条 -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">进度</span>
                            <span class="text-sm font-medium text-gray-700"><span id="uploadPercent">0</span>%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="uploadProgressBar" class="bg-green-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    <!-- 上传速度 -->
                    <div class="flex justify-between">
                        <span class="text-sm text-gray-600">上传速度</span>
                        <span class="text-sm font-medium text-gray-900" id="uploadSpeedDetails">-- MB/s</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 服务状态 -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">服务状态</h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <!-- Telegram Files 服务 -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-medium text-gray-900">Telegram Files</h4>
                            <span id="telegramStatus" class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">检查中</span>
                        </div>
                        <div class="text-sm text-gray-600" id="telegramDetails">加载中...</div>
                    </div>

                    <!-- 同步服务 -->
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="text-sm font-medium text-gray-900">自动同步服务</h4>
                            <span id="syncStatus" class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">检查中</span>
                        </div>
                        <div class="text-sm text-gray-600" id="syncDetails">加载中...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 统计信息和图表 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- 同步统计 -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">同步统计</h3>
                </div>
                <div class="px-4 py-5 sm:p-6">
                    <dl class="grid grid-cols-1 gap-5 sm:grid-cols-2">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">总文件数</dt>
                            <dd class="mt-1 text-3xl font-semibold text-gray-900" id="totalFiles">0</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">总大小</dt>
                            <dd class="mt-1 text-3xl font-semibold text-gray-900" id="totalSize">0 MB</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">成功次数</dt>
                            <dd class="mt-1 text-3xl font-semibold text-green-600" id="successCount">0</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">最后同步</dt>
                            <dd class="mt-1 text-sm text-gray-900" id="lastSync">-</dd>
                        </div>
                    </dl>
                </div>
            </div>

            <!-- 系统资源图表 -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">系统资源</h3>
                </div>
                <div class="px-4 py-5 sm:p-6">
                    <canvas id="resourceChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- 最近上传文件 -->
        <div class="bg-white shadow rounded-lg mb-6">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
                <h3 class="text-lg leading-6 font-medium text-gray-900">最近上传文件</h3>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">文件名</th>
                                <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody id="recentFiles" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="2" class="px-6 py-4 text-sm text-gray-500 text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 实时日志 -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-4 py-5 sm:px-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">实时日志</h3>
                <div class="flex space-x-2">
                    <button onclick="switchLog('sync')" id="syncLogBtn" class="px-3 py-1 text-xs font-medium rounded-md bg-indigo-600 text-white">同步日志</button>
                    <button onclick="switchLog('rclone')" id="rcloneLogBtn" class="px-3 py-1 text-xs font-medium rounded-md bg-gray-200 text-gray-700">Rclone 日志</button>
                </div>
            </div>
            <div class="px-4 py-5 sm:p-6">
                <div id="logContainer" class="bg-gray-900 rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm text-green-400">
                    <div id="logContent">加载中...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- 修改密码模态框 -->
    <div id="changePasswordModal" class="hidden fixed z-10 inset-0 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <!-- 背景遮罩 -->
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeChangePasswordModal()"></div>

            <!-- 模态框居中 -->
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

            <!-- 模态框内容 -->
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                修改密码
                            </h3>
                            <div class="mt-4">
                                <form id="changePasswordForm" class="space-y-4">
                                    <!-- 原密码 -->
                                    <div>
                                        <label for="oldPassword" class="block text-sm font-medium text-gray-700">原密码</label>
                                        <input type="password" id="oldPassword" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="请输入原密码">
                                    </div>

                                    <!-- 新密码 -->
                                    <div>
                                        <label for="newPassword" class="block text-sm font-medium text-gray-700">新密码</label>
                                        <input type="password" id="newPassword" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="至少 6 个字符">
                                    </div>

                                    <!-- 确认密码 -->
                                    <div>
                                        <label for="confirmPassword" class="block text-sm font-medium text-gray-700">确认新密码</label>
                                        <input type="password" id="confirmPassword" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                            placeholder="再次输入新密码">
                                    </div>

                                    <!-- 错误提示 -->
                                    <div id="passwordError" class="hidden bg-red-50 border border-red-200 rounded-md p-3">
                                        <p class="text-sm text-red-800" id="passwordErrorText"></p>
                                    </div>

                                    <!-- 成功提示 -->
                                    <div id="passwordSuccess" class="hidden bg-green-50 border border-green-200 rounded-md p-3">
                                        <p class="text-sm text-green-800" id="passwordSuccessText"></p>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="changePasswordBtn" onclick="submitChangePassword()"
                        class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:ml-3 sm:w-auto sm:text-sm">
                        确认修改
                    </button>
                    <button type="button" onclick="closeChangePasswordModal()"
                        class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentLog = 'sync';
        let resourceChart = null;
        let updateInterval = null;

        // 登出函数
        async function logout() {
            try {
                await axios.post('/logout');
                window.location.href = '/';
            } catch (error) {
                console.error('登出失败:', error);
            }
        }

        // 打开修改密码模态框
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('hidden');
            // 清空表单
            document.getElementById('changePasswordForm').reset();
            document.getElementById('passwordError').classList.add('hidden');
            document.getElementById('passwordSuccess').classList.add('hidden');
        }

        // 关闭修改密码模态框
        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('hidden');
        }

        // 提交修改密码
        async function submitChangePassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorDiv = document.getElementById('passwordError');
            const errorText = document.getElementById('passwordErrorText');
            const successDiv = document.getElementById('passwordSuccess');
            const successText = document.getElementById('passwordSuccessText');
            const submitBtn = document.getElementById('changePasswordBtn');

            // 隐藏之前的提示
            errorDiv.classList.add('hidden');
            successDiv.classList.add('hidden');

            // 验证输入
            if (!oldPassword || !newPassword || !confirmPassword) {
                errorText.textContent = '请填写所有字段';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPassword.length < 6) {
                errorText.textContent = '新密码至少需要 6 个字符';
                errorDiv.classList.remove('hidden');
                return;
            }

            if (newPassword !== confirmPassword) {
                errorText.textContent = '两次输入的新密码不一致';
                errorDiv.classList.remove('hidden');
                return;
            }

            // 禁用提交按钮
            submitBtn.disabled = true;
            submitBtn.textContent = '修改中...';

            try {
                const response = await axios.post('/change-password', {
                    old_password: oldPassword,
                    new_password: newPassword
                });

                if (response.data.success) {
                    successText.textContent = response.data.message;
                    successDiv.classList.remove('hidden');
                    // 3 秒后关闭模态框
                    setTimeout(() => {
                        closeChangePasswordModal();
                    }, 3000);
                } else {
                    errorText.textContent = response.data.message;
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorText.textContent = error.response?.data?.message || '修改失败，请重试';
                errorDiv.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '确认修改';
            }
        }

        // 切换日志
        function switchLog(type) {
            currentLog = type;
            document.getElementById('syncLogBtn').className = type === 'sync' ?
                'px-3 py-1 text-xs font-medium rounded-md bg-indigo-600 text-white' :
                'px-3 py-1 text-xs font-medium rounded-md bg-gray-200 text-gray-700';
            document.getElementById('rcloneLogBtn').className = type === 'rclone' ?
                'px-3 py-1 text-xs font-medium rounded-md bg-indigo-600 text-white' :
                'px-3 py-1 text-xs font-medium rounded-md bg-gray-200 text-gray-700';
            loadLogs();
        }

        // 加载日志
        async function loadLogs() {
            try {
                const endpoint = currentLog === 'sync' ? '/api/logs/sync' : '/api/logs/rclone';
                const response = await axios.get(endpoint + '?lines=50');
                const logs = response.data.logs || [];

                document.getElementById('logContent').innerHTML = logs.length > 0
                    ? logs.map(log => `<div class="mb-1">${escapeHtml(log)}</div>`).join('')
                    : '<div class="text-gray-500">暂无日志</div>';

                // 自动滚动到底部
                const container = document.getElementById('logContainer');
                container.scrollTop = container.scrollHeight;
            } catch (error) {
                console.error('加载日志失败:', error);
                document.getElementById('logContent').innerHTML = '<div class="text-red-400">加载失败</div>';
            }
        }

        // HTML 转义
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // 更新仪表板数据
        async function updateDashboard() {
            try {
                const response = await axios.get('/api/dashboard');
                const data = response.data;

                // 更新系统信息
                if (data.system) {
                    document.getElementById('cpuUsage').textContent = `${data.system.cpu.percent}%`;
                    document.getElementById('memoryUsage').textContent = `${data.system.memory.used_gb} / ${data.system.memory.total_gb} GB`;
                    document.getElementById('diskUsage').textContent = `${data.system.disk.used_gb} / ${data.system.disk.total_gb} GB`;

                    // 更新图表
                    updateChart(data.system);
                }

                // 更新云端统计
                if (data.cloud_stats) {
                    document.getElementById('cloudStorage').textContent = `${data.cloud_stats.total_size_gb} GB`;
                }

                // 更新服务状态
                if (data.services) {
                    updateServiceStatus('telegram', data.services.telegram_files);
                    updateServiceStatus('sync', data.services.sync_service);
                }

                // 更新同步统计
                if (data.sync_stats) {
                    document.getElementById('totalFiles').textContent = data.sync_stats.total_synced || 0;
                    document.getElementById('totalSize').textContent = `${data.sync_stats.total_size_mb || 0} MB`;
                    document.getElementById('successCount').textContent = data.sync_stats.success_count || 0;
                    document.getElementById('lastSync').textContent = data.sync_stats.last_sync || '-';

                    // 更新最近文件
                    updateRecentFiles(data.sync_stats.recent_files || []);
                }

                // 更新网络流量统计
                if (data.network_stats) {
                    document.getElementById('uploadSpeed').textContent = `${data.network_stats.upload_speed_mbps} Mbps`;
                    document.getElementById('downloadSpeed').textContent = `${data.network_stats.download_speed_mbps} Mbps`;
                    document.getElementById('totalUploaded').textContent = `${data.network_stats.total_sent_gb} GB`;
                    document.getElementById('totalDownloaded').textContent = `${data.network_stats.total_recv_gb} GB`;
                }

                // 更新云存储配额
                if (data.cloud_quota) {
                    const percent = data.cloud_quota.used_percent || 0;
                    document.getElementById('quotaPercent').textContent = `${percent}%`;
                    document.getElementById('quotaBar').style.width = `${percent}%`;
                    document.getElementById('quotaTotal').textContent = `${data.cloud_quota.total_gb} GB`;
                    document.getElementById('quotaUsed').textContent = `${data.cloud_quota.used_gb} GB`;
                    document.getElementById('quotaFree').textContent = `${data.cloud_quota.free_gb} GB`;

                    // 根据使用率改变颜色
                    const bar = document.getElementById('quotaBar');
                    if (percent < 70) {
                        bar.className = 'bg-green-600 h-4 rounded-full transition-all duration-300';
                    } else if (percent < 90) {
                        bar.className = 'bg-yellow-600 h-4 rounded-full transition-all duration-300';
                    } else {
                        bar.className = 'bg-red-600 h-4 rounded-full transition-all duration-300';
                    }
                }

                // 更新上传进度
                if (data.upload_progress) {
                    const uploadSection = document.getElementById('uploadProgressSection');
                    if (data.upload_progress.is_uploading) {
                        uploadSection.classList.remove('hidden');
                        document.getElementById('currentFile').textContent = data.upload_progress.current_file || '处理中...';
                        document.getElementById('uploadPercent').textContent = data.upload_progress.progress || 0;
                        document.getElementById('uploadProgressBar').style.width = `${data.upload_progress.progress || 0}%`;
                        document.getElementById('uploadSpeedDetails').textContent = data.upload_progress.speed || 'N/A';
                        document.getElementById('uploadStatus').textContent = data.upload_progress.status || '正在上传';
                    } else {
                        uploadSection.classList.add('hidden');
                    }
                }

            } catch (error) {
                console.error('更新数据失败:', error);
            }
        }

        // 更新服务状态
        function updateServiceStatus(type, status) {
            const statusEl = document.getElementById(type === 'telegram' ? 'telegramStatus' : 'syncStatus');
            const detailsEl = document.getElementById(type === 'telegram' ? 'telegramDetails' : 'syncDetails');

            if (status.active) {
                statusEl.className = 'px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800';
                statusEl.textContent = '运行中';
                detailsEl.innerHTML = `
                    <div>PID: ${status.pid || 'N/A'}</div>
                    <div>内存: ${status.memory || 'N/A'}</div>
                `;
            } else {
                statusEl.className = 'px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800';
                statusEl.textContent = '已停止';
                detailsEl.textContent = '服务未运行';
            }
        }

        // 更新最近文件
        function updateRecentFiles(files) {
            const tbody = document.getElementById('recentFiles');
            if (files.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="px-6 py-4 text-sm text-gray-500 text-center">暂无数据</td></tr>';
                return;
            }

            tbody.innerHTML = files.map(file => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHtml(file.name)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${file.action === 'Copied' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${file.action === 'Copied' ? '已复制' : '已移动'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('resourceChart').getContext('2d');
            resourceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['CPU 使用率', 'CPU 空闲', '内存使用', '内存空闲', '磁盘使用', '磁盘空闲'],
                    datasets: [{
                        data: [0, 100, 0, 100, 0, 100],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(229, 231, 235, 0.3)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(229, 231, 235, 0.3)',
                            'rgba(234, 179, 8, 0.8)',
                            'rgba(229, 231, 235, 0.3)'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // 更新图表
        function updateChart(system) {
            if (!resourceChart || !system) return;

            const cpuPercent = system.cpu.percent || 0;
            const memPercent = system.memory.percent || 0;
            const diskPercent = system.disk.percent || 0;

            resourceChart.data.datasets[0].data = [
                cpuPercent,
                100 - cpuPercent,
                memPercent,
                100 - memPercent,
                diskPercent,
                100 - diskPercent
            ];
            resourceChart.update();
        }

        // ==================== 云存储配置功能 ====================

        // 加载 rclone 远程存储列表
        async function loadRcloneRemotes() {
            try {
                const response = await axios.get('/api/rclone/remotes');
                if (response.data.success) {
                    const remotes = response.data.remotes;
                    const select = document.getElementById('remoteSelect');

                    // 清空现有选项
                    select.innerHTML = '<option value="">-- 请选择云存储 --</option>';

                    // 添加远程存储选项
                    remotes.forEach(remote => {
                        const option = document.createElement('option');
                        option.value = remote.name;
                        option.textContent = `${remote.name} (${remote.type})`;
                        select.appendChild(option);
                    });

                    showCloudConfigMessage('success', '已加载远程存储列表');
                } else {
                    showCloudConfigMessage('error', response.data.message || '加载远程存储失败');
                }
            } catch (error) {
                console.error('加载远程存储失败:', error);
                showCloudConfigMessage('error', error.response?.data?.message || '加载远程存储失败');
            }
        }

        // 加载当前配置
        async function loadCurrentCloudConfig() {
            try {
                const response = await axios.get('/api/rclone/current-config');
                if (response.data.success) {
                    document.getElementById('currentRemote').textContent = response.data.remote || '未配置';
                    document.getElementById('currentPath').textContent = response.data.path || '未配置';
                }
            } catch (error) {
                console.error('加载当前配置失败:', error);
                document.getElementById('currentRemote').textContent = '加载失败';
                document.getElementById('currentPath').textContent = '加载失败';
            }
        }

        // 远程存储选择变化
        function onRemoteSelect() {
            const remote = document.getElementById('remoteSelect').value;
            const path = document.getElementById('targetPath').value;

            if (remote) {
                updatePathPreview(remote, path);
            } else {
                document.getElementById('pathPreview').style.display = 'none';
            }
        }

        // 路径输入变化
        document.addEventListener('DOMContentLoaded', () => {
            const targetPath = document.getElementById('targetPath');
            if (targetPath) {
                targetPath.addEventListener('input', () => {
                    const remote = document.getElementById('remoteSelect').value;
                    const path = targetPath.value;
                    if (remote) {
                        updatePathPreview(remote, path);
                    }
                });
            }
        });

        // 更新路径预览
        function updatePathPreview(remote, path) {
            if (!path.startsWith('/') && path) {
                path = '/' + path;
            }
            const fullPath = `${remote}:${path}`;
            document.getElementById('fullPathPreview').textContent = fullPath;
            document.getElementById('pathPreview').style.display = 'block';
        }

        // 测试连接
        async function testConnection() {
            const remote = document.getElementById('remoteSelect').value;
            const path = document.getElementById('targetPath').value;

            if (!remote) {
                showCloudConfigMessage('error', '请先选择云存储');
                return;
            }

            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = '测试中...';

            try {
                const response = await axios.post('/api/rclone/browse', {
                    remote: remote,
                    path: path || '/'
                });

                if (response.data.success) {
                    const dirCount = response.data.directories.length;
                    showCloudConfigMessage('success', `连接成功！找到 ${dirCount} 个子目录`);
                } else {
                    showCloudConfigMessage('error', response.data.message || '连接失败');
                }
            } catch (error) {
                console.error('测试连接失败:', error);
                showCloudConfigMessage('error', error.response?.data?.message || '连接测试失败');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '测试连接';
            }
        }

        // 保存云存储配置
        async function saveCloudConfig() {
            const remote = document.getElementById('remoteSelect').value;
            const path = document.getElementById('targetPath').value;

            if (!remote) {
                showCloudConfigMessage('error', '请先选择云存储');
                return;
            }

            // 确认对话框
            if (!confirm(`确定要更改云存储配置吗？\n\n远程存储: ${remote}\n目标路径: ${path || '/'}\n\n注意：保存后将自动重启同步服务`)) {
                return;
            }

            const saveBtn = document.getElementById('saveCloudConfigBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';

            try {
                const response = await axios.post('/api/rclone/update-config', {
                    remote: remote,
                    path: path
                });

                if (response.data.success) {
                    showCloudConfigMessage('success', response.data.message || '配置保存成功！');

                    // 更新当前配置显示
                    setTimeout(() => {
                        loadCurrentCloudConfig();
                        updateDashboard();
                    }, 2000);
                } else {
                    showCloudConfigMessage('error', response.data.message || '保存失败');
                }
            } catch (error) {
                console.error('保存配置失败:', error);
                showCloudConfigMessage('error', error.response?.data?.message || '保存配置失败');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = '保存配置';
            }
        }

        // 显示云存储配置消息
        function showCloudConfigMessage(type, message) {
            const messageDiv = document.getElementById('cloudConfigMessage');
            const contentDiv = document.getElementById('cloudConfigMessageContent');
            const textP = document.getElementById('cloudConfigMessageText');

            messageDiv.classList.remove('hidden');
            textP.textContent = message;

            if (type === 'success') {
                contentDiv.className = 'rounded-md p-4 bg-green-50';
                textP.className = 'text-sm font-medium text-green-800';
            } else {
                contentDiv.className = 'rounded-md p-4 bg-red-50';
                textP.className = 'text-sm font-medium text-red-800';
            }

            // 5秒后自动隐藏
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 5000);
        }

        // ==================== 初始化 ====================

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 初始化图表
            initChart();

            // 加载初始数据
            await updateDashboard();
            await loadLogs();
            await loadRcloneRemotes();  // 加载云存储列表
            await loadCurrentCloudConfig();  // 加载当前配置

            // 设置定时更新
            updateInterval = setInterval(() => {
                updateDashboard();
                loadLogs();
            }, 5000); // 每 5 秒更新一次
        });

        // 页面卸载时清理
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
